<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Social App â€“ Simple Stable</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:system-ui;background:#111;color:white;padding:20px}
.card{background:#1f1f1f;padding:16px;border-radius:12px;margin-top:15px}
button{padding:6px 12px;border:none;border-radius:8px;margin-top:8px;cursor:pointer}
.like{background:#10b981;color:white}
.primary{background:#4f46e5;color:white}
textarea{width:100%;padding:8px;border-radius:8px;background:#222;color:white}
</style>
</head>
<body>

<h2>ðŸ”¥ Social App â€“ Stable Version</h2>

<div class="card">
<textarea id="postInput" placeholder="Write something..."></textarea>
<br>
<button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script>
const supabase = window.supabase.createClient(
 "https://dgehzagvyrxbnnvgsiff.supabase.co",
 "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = crypto.randomUUID(); // simple guest id

async function loadPosts(){
 const { data } = await supabase
  .from("posts")
  .select("*")
  .order("created_at",{ascending:false});

 feed.innerHTML="";

 for(const post of data){

   const { count } = await supabase
     .from("likes")
     .select("*",{count:"exact",head:true})
     .eq("post_id",post.id);

   const { data:liked } = await supabase
     .from("likes")
     .select("id")
     .eq("post_id",post.id)
     .eq("user_id",currentUser);

   const div=document.createElement("div");
   div.className="card";

   div.innerHTML=`
     <b>${post.username||"User"}</b>
     <div>${post.content}</div>
     <button class="like" onclick="toggleLike('${post.id}')">
       ${liked.length?"Unlike":"Like"} (${count||0})
     </button>
   `;

   feed.appendChild(div);
 }
}

async function toggleLike(postId){

 const { data } = await supabase
  .from("likes")
  .select("id")
  .eq("post_id",postId)
  .eq("user_id",currentUser);

 if(data.length){
   await supabase
    .from("likes")
    .delete()
    .eq("post_id",postId)
    .eq("user_id",currentUser);
 }else{
   await supabase
    .from("likes")
    .insert([{post_id:postId,user_id:currentUser}]);
 }

 await loadPosts();
}

postBtn.onclick=async ()=>{
 const content=postInput.value.trim();
 if(!content) return;

 await supabase.from("posts").insert([{
   content,
   username:"Guest"
 }]);

 postInput.value="";
 await loadPosts();
};

loadPosts();
setInterval(loadPosts,3000); // auto refresh every 3 seconds

</script>

</body>
</html>